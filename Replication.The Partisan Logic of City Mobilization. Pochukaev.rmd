---
title: "Replication 'The Partisan Logic of City Mobilization: Evidence from State
Lobbying Disclosures'"
author: "Pochukaev Daniil"
output: rmarkdown::github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Репликация работы The Partisan Logic of City Mobilization: Evidence from State
Lobbying Disclosures, автора J. A. Payson. В работе используются панельные данные, содержащие информацию о муниципальном лоббировании во всех 50 штатах США и характеристиках города для каждого из примерно 1200 городов США с населением не
менее 20 000 человек и охватывает период с 2006 по 2014 год

Гипотеза Пэйсона: города (местные чиновники) значительно чаще нанимают внешнего
лоббиста после того, как их округ избирает представителя штата от идеологически
противоположной политической партии.

В работе автор пишет, что использует метод “Разность разностей" (Difference-in-Differences, далее DiD), однако на деле, он скорее использует "two-way fixed effects" регрессию. 

```{r message=F, warning=F, results= "hold"}
library(plm)
library(sjPlot)
library(xtable)
library(ggplot2)
library(stargazer)
library(lfe)
library(effects)
library(dplyr)
library(pglm)
library(plm)
library(gghighlight)
```
```{r message=F, warning=F}
pretty <- function(x) {
  paste(prettyNum(x, big.mark = ","))}
num.cities <- function(x) {
  length(which(getfe(x)=="fips"))}
N <- function(x) {
  x$N}
getmean <- function(x) {
  round(mean(x$response), 2)}
dta <- read.csv("panel.csv")
```

```{r message=F, warning=F}
str(dta$lobby)
str(dta$mismatch)
```


```{r message=F, warning=F}
dta$lobby = as.factor(dta$lobby)
dta$mismatch = as.factor(dta$mismatch)
```


```{r message=F, warning=F}
ggplot(dta, aes(as.factor(mismatch), fill= lobby)) + geom_bar() + theme_minimal() + ylab('')+ xlab("Несовпадение в идеологии между городом и представителем от штата (0 - несовпадение)") + ggtitle("Было ли лоббирование") 
```

На рисунке мы видим, что превалирующее число наблюдений не имеют
воздействия: идеология городов и представителей от штатов совпадает. Также мы
видим, что распределение лоббирования как для переменных с совпадением
политической идеологий, так и без – чуть менее половины городов лоббирует.

Модель, предложенная автором статьи:

```{r message=F, warning=F}

m <- felm(lobby ~ mismatch + log.pop | fips + year | 0 | fips, 
          data = subset(dta, pres.dem.tercile != "Moderate"))

m1 <- felm(lobby ~ mismatch + log.pop | fips + state.by.year | 0 | fips, 
           data = subset(dta, pres.dem.tercile != "Moderate"))


m2 <- felm(lobby ~ mismatch + log.pop + log.income + log.own.source +
             pct.white + log.med.house | fips + state.by.year | 0 | fips, 
           data = subset(dta, pres.dem.tercile != "Moderate"))


tab_model(m, m1, m2, collapse.ci = TRUE, show.se = TRUE, dv.labels = c("Without covariates and with fixed effects by city year", "Without covariates and fixed effects by city and state by year", "with covariates andfixed effects by city and state by year"))
```

Результаты по всем спецификациям показывают, что когда в городе избирается
представитель противоположной политической партии, вероятность лоббирования
увеличивается на 4-7 процентных пунктов. Включение дополнительных ковариаций и
более строгих фиксированных эффектов только увеличивает силу эффекта воздействия.
Фиксированные эффекты по штату к году (во 2 и 3 моделях) подразумевает учет
особенностей законодательного органа каждого штата в каждом году, которые могут
увеличить/уменьшить вероятность лоббирования всеми городами. Соответственно,
фиксированные эффекты по городу подразумевают учет специфики городов, по году –
учет специфики избирательных особенностей в каждом году.

Однако, как былол уже сказано выше, это нельзя назвать DiD анализом.

```{r message=F, warning=F}
m <- felm(lobby ~  mismatch.lead2 + mismatch.lead1 + mismatch + mismatch.lag1 + log.pop + 
            log.income + log.own.source + pct.white | fips + state.by.year | 0 | fips, 
          data = subset(dta, pres.dem.tercile != "Moderate"))

## Format data for figure
beta <- c(m$coefficients[1], m$coefficients[2], m$coefficients[3])
se <- c(m$cse[1], m$cse[2], m$cse[3])
figdata <- data.frame(beta = c(beta), se = c(se), x = c(-.5, 0, .5))

## Figure: Leads and Lags
(p <- ggplot(figdata, aes(x = x, y = beta)) + 
    geom_point(size = 2) +
    geom_errorbar(aes(ymin = beta - (1.9 * se), ymax = beta + (1.9 * se)), 
                  size = .5, width = .1) +
    geom_hline(yintercept = 0, linetype = 2) +
    scale_x_continuous(breaks = c(-.5, 0, .5), 
                       labels = c("2 Years Prior", "1 Year Prior", "Mismatch")) +
    geom_vline(xintercept = .25) +
    theme_bw(base_family = "serif", base_size = 12)  +
    labs(y = "Effect on Lobbying Probability", 
         x = "Years Relative to Treatment"))
```

Рисунок 2 (в авторской версии) призван проверить допущение о параллельных трендах: когда на должность избирается представитель
штата от противоположной политической партии, города с большей вероятностью
будут лоббировать


Проблема подхода автора: 

- Мметод felm представляет собой простую OLS регрессию с фиксированными
эффектами (из описания пакета). Зависимая переменная автора - бинарная.
Отсюда возникает неясность, почему автор выбрал такую модель, а не
логистическую;

- Автор строит обычную OLS регрессию, пусть и с фиксированными эффектами по городам и годам, либо по городам и штатам к годам. Это не является методом DiD, на которую он претендует в статье. Также в связи с этим, дуступная панель играет в анализе меньшую роль. Далее я постараюсь исправить этот недостаток и посмотреть, к каким выводам придет анализ с помощью DiD.


## Новое решение

В связи с упомянутыми выше проблемами я решил попробовать сделать
собственный анализ DiD, на предложенных автором данных. Для того, чтобы
внимательно рассмотреть данные автора я создал переменную “mislob”, в
которой было 4 категории и NA:

a) matchlob = идеологии совпадают, лоббирование было;

b) mislob = идеологии города и представителя от штата не совпадают и лоббирование было;

c) matchunlob = идеологии совпадают, лоббирования не было;

d) misunlob = идеологии не совпадают, лоббирования не было;

```{r message=F, warning=F}
dta_ = dta |>
  filter(pres.dem.tercile != "Moderate")
```

```{r message=F, warning=F}
dta = dta |>
    mutate(mislob = case_when (lobby == 1 & mismatch == 1 ~ "mislob", 
                           lobby == 0 & mismatch == 1 ~ "misunlob", 
                           lobby == 1 & mismatch == 0 ~ "matchlob",
                           lobby == 0 & mismatch == 0 ~ "matchunlob"))
```


Эти переменные распределены в каждом году следующим образом:

```{r message=F, warning=F}
ggplot(dta, aes(mislob)) + geom_bar()+facet_wrap(~year)+ theme_minimal()+theme(  axis.text.x = element_text(angle = 18), axis.text=element_text(size=10),  
        legend.position = "bottom") + xlab('') + ylab("")
```

Я также сделал распределение, исключив из анализа переменные, где
выбранным от штата представителем являлся беспартийный кандидат, которого
сложнее было определить по идеологии

```{r message=F, warning=F}
dta_ = dta_ |>
    mutate(mislob = case_when (lobby == 1 & mismatch == 1 ~ "mislob", 
                               lobby == 0 & mismatch == 1 ~ "misunlob", 
                           lobby == 1 & mismatch == 0 ~ "matchlob",
                           lobby == 0 & mismatch == 0 ~ "matchunlob"))
```

```{r message=F, warning=F}
ggplot(dta_, aes(mislob)) + geom_bar()+facet_wrap(~year)+ theme_minimal() +theme(  axis.text.x = element_text(angle = 18), axis.text=element_text(size=10),  
        legend.position = "bottom") + xlab('') + ylab("")
```

На обоих графиках мы видим, что во все года, за исключением 2012 и 2013, при
отсутствии совпадения в идеологии (т.е. воздействие есть), чуть больше городов не
лоббирует, чем лоббирует, что противоположно гипотезе автора реплицируемой статьи.
Также мы видим, что в городах, воздействия (т.е. несоответствия в идеологии) не было
– также больше городов не прибегают к лоббированию, чем прибегают, но визуально
этот разрыв кажется немногим больше и имеется во всех городах без исключения).
Уменьшение разницы между лоббирующими и нелоббирующими городами при
наличии несоответствие говорит в пользу идеи автора статьи, но насколько это
различие значимо?

```{r message=F, warning=F}
dta_state = dta_ |>
  filter(mislob == "mislob") 
ggplot(dta_state, aes(state)) + geom_bar(aes(x= forcats::fct_infreq(state))) + theme_minimal()+ theme(plot.title = element_text(size=14), axis.text.x = element_text(angle = 25), axis.text=element_text(size=7),  
        legend.position = "bottom")+ ylab('')+ xlab("Штаты, где было несовпадение идеологии и было лобирование: число наблюдений по штату")
```

На рисунке мы видим, что даже внутри штатов ситуация неоднозначна.
Во-первых, в только 24 из 50 штатов города лоббировали свои интересы при
несовпадении идеологии с кандидатом от штата. Во-вторых, ситуация внутри штатов
также сильно разница. Только в 10 штатах наблюдений было более 10 наблюдений, где
лоббирование и несовпадение интересов имели были одновременно (и это без контроля
по годам, то есть это значит что это может быть всего 1-2 города в штате, которые
постоянно лоббируют свои интересы). Это говорит о том, что экстраполяция автором
статьи данных на все США крайне проблематично.



```{r message=F, warning=F}
dta_state_misunlob = dta_ |>
  filter(mislob == "misunlob")
ggplot(dta_state_misunlob, aes(state)) + geom_bar(aes(x= forcats::fct_infreq(state))) + facet_wrap(~mislob)+theme_minimal()+ theme(plot.title = element_text(size=14), axis.text.x = element_text(angle = 25), axis.text=element_text(size=7),  
        legend.position = "bottom")+ ylab('')+ xlab("Штаты, где не было совпадения идеологии и не было лобирования: число наблюдений по штату")
```

В штатах, где не лоббировали при наличии воздействия ситуация похожа, но все
же распределена более равномерно: таких штатов 29 и штатов, где более 10
наблюдений без лоббирования – 14.
Таким образом мы видим, что даже если рассматривать анализ воздействия
несоответствия на лоббирование внутри одного года – анализ должен получится не
таким однозначным, как это описывал автор, как минимум это проблематично
экстраполировать на США в целом.

```{r message=F, warning=F}
dta_state_match = dta_ |>
  filter(mislob == "matchlob")
ggplot(dta_state_match, aes(state)) + geom_bar(aes(x= forcats::fct_infreq(state))) + facet_wrap(~mislob)+theme_minimal()+ theme(plot.title = element_text(size=14), axis.text.x = element_text(angle = 25), axis.text=element_text(size=7),  
        legend.position = "bottom") + ylab('')+ xlab("Штаты, где было совпадение идеологии и было лобирование: число наблюдений по штату")

```

```{r message=F, warning=F}
dta_state_matchunlob = dta_ |>
  filter(mislob == "matchunlob") 
ggplot(dta_state_matchunlob, aes(state)) + geom_bar(aes(x= forcats::fct_infreq(state))) + theme_minimal()+ theme(plot.title = element_text(size=14), axis.text.x = element_text(angle = 25), axis.text=element_text(size=7),  
        legend.position = "bottom")+ ylab('')+ xlab("Штаты, где было несовпадение идеологии и было лобирование: число наблюдений по штату")
```


### Новое решение: Попарное DiD

Я решил сделать DiD анализ на данных автора статьи: 
сделал множество датасетов, где года были представлены как t1 и t2 (например 2006 и 2007 гг.). на основе этих датасетов мы построили несколько панельных логистических регрессий, где смотрели как с изменением года, появление несоответствия между штатами влияет на отношение шансов лоббирования.

Сначала посмотрим как это будет работать, если мы не будем убирать беспартийных кандидатов 

```{r message=F, warning=F}
data_2007 = dta|>
  filter(year == c("2006","2007"))
data_2008 = dta|>
  filter(year == c("2007","2008"))
data_2009 = dta|>
  filter(year == c("2008","2009"))
data_2010 = dta|>
  filter(year == c("2009","2010"))
data_2011 = dta|>
  filter(year == c("2010","2011"))
data_2012 = dta|>
  filter(year == c("2011","2012"))
data_2013 = dta|>
  filter(year == c("2012","2013"))
data_2014 = dta|>
  filter(year == c("2013","2014"))
```

С беспартийными кандидатами
Без ковариат: 

```{r message=F, warning=F}
m_pglm_2007 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2007)
tab_model(m_pglm_2007, collapse.ci = TRUE, show.se = TRUE)
m_pglm_2008 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2008)
m_pglm_2009 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2009)
m_pglm_2010 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2010)
m_pglm_2011 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2011)
m_pglm_2012 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2012)
m_pglm_2013 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2013)
m_pglm_2014 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2014)
tab_model(m_pglm_2007,m_pglm_2008,m_pglm_2009,m_pglm_2010,m_pglm_2011,m_pglm_2012,m_pglm_2013,m_pglm_2014, collapse.ci = TRUE, dv.labels = c("2007", "2008","2009","2010","2011","2012","2013","2014"))
```

По результатам полученных моделей мы видим, что при фиксировании времени
t1 как отсутствие идеологического несоответствия (воздействия) за год до воздействия,
при переходе ко времени появления идеологического несоответствия (время t2)
изменяется отношения шансов того, что “города” решат лоббировать свои интересы не
значимо не в одном из временных промежутков на протяжении всей панели.

С добавлением ковариат:

```{r message=F, warning=F}
m_pglm_2007_cov <- pglm(lobby ~ mismatch + log.pop + log.income + log.own.source +
             pct.white + log.med.house  + factor(year),model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2007)
m_pglm_2008_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2008)
m_pglm_2009_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2009)
m_pglm_2010_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2010)
m_pglm_2011_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2011)
m_pglm_2012_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2012)
m_pglm_2013_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2013)
m_pglm_2014_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2014)
tab_model(m_pglm_2007_cov, m_pglm_2008_cov,m_pglm_2009_cov,m_pglm_2010_cov,m_pglm_2011_cov,m_pglm_2012_cov,m_pglm_2013_cov,m_pglm_2014_cov, collapse.ci = TRUE,dv.labels = c("2007", "2008","2009","2010","2011","2012","2013","2014"))
```

В случае добавления ковариат, мы видим маргинальную значимость в 2008 и 2010 гг. В остальных случах эффекта идеологического несоответствия на лоббирования нет. Посмотрим что покажет модель, если убрать беспартийных кандидатов, которые "зашумляют" данные.

Если мы убираем беспартийных кандидатов, чтобы сделать более "чистый" анализ:

```{r message=F, warning=F}
data_2007 = dta_|>
  filter(year == c("2006","2007"))
data_2008 = dta_|>
  filter(year == c("2007","2008"))
data_2009 = dta_|>
  filter(year == c("2008","2009"))
data_2010 = dta_|>
  filter(year == c("2009","2010"))
data_2011 = dta_|>
  filter(year == c("2010","2011"))
data_2012 = dta_|>
  filter(year == c("2011","2012"))
data_2013 = dta_|>
  filter(year == c("2012","2013"))
data_2014 = dta_|>
  filter(year == c("2013","2014"))
```

Без ковариат:

```{r message=F, warning=F}
m_pglm_2007 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2007)

m_pglm_2008 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2008)
m_pglm_2009 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2009)
m_pglm_2010 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2010)
m_pglm_2011 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2011)
m_pglm_2012 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2012)
m_pglm_2013 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2013)
m_pglm_2014 <- pglm(lobby ~ mismatch + log.pop + factor(year) ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2014)
tab_model(m_pglm_2007,m_pglm_2008,m_pglm_2009,m_pglm_2010,m_pglm_2011,m_pglm_2012,m_pglm_2013,m_pglm_2014, collapse.ci = TRUE, dv.labels = c("2007", "2008","2009","2010","2011","2012","2013","2014"))
```

С добавлением ковариат: 

```{r message=F, warning=F}
m_pglm_2007_cov <- pglm(lobby ~ mismatch + log.pop + log.income + log.own.source +
             pct.white + log.med.house  + factor(year),model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2007)
m_pglm_2008_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2008)
m_pglm_2009_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2009)
m_pglm_2010_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2010)
m_pglm_2011_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2011)
m_pglm_2012_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2012)
m_pglm_2013_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2013)
m_pglm_2014_cov <- pglm(lobby ~ mismatch + log.pop + factor(year)+ log.income + log.own.source +
             pct.white + log.med.house  ,model = "pooling", method = "bfgs", family = binomial('probit'), index = c("fips", "state.by.year"), data= data_2014)
tab_model(m_pglm_2007_cov, m_pglm_2008_cov,m_pglm_2009_cov,m_pglm_2010_cov,m_pglm_2011_cov,m_pglm_2012_cov,m_pglm_2013_cov,m_pglm_2014_cov, collapse.ci = TRUE,dv.labels = c("2007", "2008","2009","2010","2011","2012","2013","2014"))
```


По результатам построенных панельных регрессий без наличия беспартийных кандидатов в анализе мы видим аналогичный результат: эффекта идеологического несоответствия на лоббирования нет. Как и предполагалось выше, беспартийные кандидаты зашумляли данны: после того, как я их исключил из анализа, мы дими, что эффекта воздействия идеологического несовпадения на лоббирование больше нет. Это наблюдается как с добавлением ковариат, так и с их отсутсвием, что противоположно выводам автора рассматриваемой статьи.

Разбив датасет на множество временных интервалов, я также дополнительно
проконтролировал модель по фиксированному эффекту года, подобно тому как сделал
автор статьи. Также мы видим, что в данных без удаления беспартийных кандидатов в
каждой модели используется тоже самое количество наблюдений, что автор
контролировал по городу с помощью переменной “fips”.


